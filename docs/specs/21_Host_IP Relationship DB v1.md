# Host/IP Relationship DB — V1 Specification (AEGIS Protocol)

**Status:** Draft (Beta)  
**Version:** V1  
**Applies to:** AEGIS Core (evidence indexing + awareness), Aurora (read-only query surface)

---

## 1. Purpose

The Host/IP Relationship DB exists to make **network identity observable** over time.

It provides an evidence-backed, queryable ledger of:

- hosts and their identifiers (hostname, machine-id, boot-id, etc.)
- IP addresses (v4/v6) and their observed assignment history
- interfaces and MAC addresses
- networks/subnets and (optional) gateways/DNS context
- observation runs (what was collected, from where, and when)
- confidence + provenance (how sure we are, and why)

This DB is **not** an inventory authority. It is an **observation store** designed to support:

- drift detection (unexpected IP change, MAC move, hostname reuse)
- continuity (mapping “this host” across time, even if IP changes)
- safe targeting (“which host is 192.168.0.127?” with evidence)

---

## 2. Scope and Non-Goals

### In scope
- LAN/VPN observed relationships (including multi-homed hosts)
- Time-series assignment history (start/end validity windows)
- Evidence references (hash/path pointers) to raw collected artifacts
- Confidence scoring and conflict marking
- Multi-source ingestion (local scan, SSH evidence, DHCP lease parsing, ARP tables)

### Non-goals (V1)
- Real-time reconciliation/automation (no corrective action)
- Authoritative CMDB replacement
- Full-blown graph DB features (this is relational with queryable edges)
- Storing sensitive payloads (raw outputs live in evidence store; DB stores references)

---

## 3. Design Principles (AEGIS Alignment)

- **Observation-first:** every relationship must be backed by an observation run and evidence reference.
- **Append-forward:** historical facts are not overwritten; new observations supersede with time windows.
- **Conflict is data:** contradictory claims are stored and flagged, not hidden.
- **Least data:** store what enables identity mapping; store references to raw evidence, not blobs.
- **Read-only by default:** Aurora queries this DB; only ingestion pipeline writes.

---

## 4. Terminology

- **Host:** a machine identity concept (may survive IP changes).
- **Endpoint:** an addressable identity at a moment (IP + optional port context); V1 tracks IP only.
- **Observation Run:** a discrete collection event with metadata + evidence pointer(s).
- **Claim:** a statement such as “host X had IP Y” for a time window, with confidence and provenance.
- **Confidence:** numeric indicator (0–100) for how strongly the system believes a claim.

---

## 5. Storage Engine and Naming

- Recommended engine: **PostgreSQL 14+**
- Schema name: `netrel_v1`
- All timestamps stored as `timestamptz` (UTC)
- Primary keys: `uuid` (generated by app)

---

## 6. Data Model Overview

Core entities:

- `hosts` — stable host identity
- `host_identifiers` — machine-id/serial/asset tags/ssh host key hashes, etc.
- `interfaces` — NICs on a host (MAC + interface name)
- `ip_addresses` — canonical IP objects
- `networks` — CIDR networks (optional but useful)
- `observations` — collection runs
- `claims_host_ip` — time-windowed IP assignment claims

Supporting entities:

- `sources` — where observations came from (collector id, method)
- `evidence_refs` — pointers/hashes to evidence artifacts
- `conflicts` — explicit conflict markers between claims

---

## 7. Tables (V1)

> Notes:
> - Use `created_at` for insert time; use `observed_at` for event time.
> - `valid_from/valid_to` represent *the best-known assignment window* from observations.
> - `valid_to = NULL` means “still believed current”.

### 7.1 `sources`
Represents a producer (collector, node, method).

**Fields**
- `source_id` (uuid, pk)
- `source_name` (text, required) — e.g., `capsuleer-collector`
- `source_type` (text, required) — `ssh`, `local_scan`, `dhcp_lease`, `arp_table`, `manual`
- `host_hint` (text, optional) — collector host
- `created_at` (timestamptz, required)

**Constraints**
- unique (`source_name`, `source_type`)

---

### 7.2 `evidence_refs`
Pointers to evidence artifacts stored elsewhere (filesystem/object store).

**Fields**
- `evidence_id` (uuid, pk)
- `evidence_kind` (text, required) — `arp`, `ip_addr`, `hostname`, `dhcp_lease`, `iface`, etc.
- `artifact_uri` (text, required) — path/uri to evidence artifact
- `artifact_sha256` (text, required) — hex sha256
- `captured_at` (timestamptz, required)
- `source_id` (uuid, fk -> `sources`)
- `created_at` (timestamptz, required)

**Constraints**
- unique (`artifact_sha256`)
- `artifact_uri` MUST NOT contain credentials/secrets

---

### 7.3 `observations`
A single run that produced one or more evidence refs and claims.

**Fields**
- `observation_id` (uuid, pk)
- `source_id` (uuid, fk -> `sources`, required)
- `collector_run_id` (text, required) — stable id from pipeline (can be timestamp-based)
- `started_at` (timestamptz, required)
- `ended_at` (timestamptz, optional)
- `scope` (text, required) — e.g., `192.168.0.0/24`, `capsuleer`, `smokehouse`
- `notes` (text, optional)
- `created_at` (timestamptz, required)

**Constraints**
- unique (`source_id`, `collector_run_id`)

---

### 7.4 `hosts`
A host identity record (stable concept).

**Fields**
- `host_id` (uuid, pk)
- `canonical_name` (text, optional) — preferred display name (e.g., `capsuleer`)
- `first_seen_at` (timestamptz, required)
- `last_seen_at` (timestamptz, required)
- `status` (text, required) — `active`, `retired`, `unknown`
- `created_at` (timestamptz, required)

**Notes**
- `canonical_name` is not guaranteed unique; uniqueness comes from identifiers.

---

### 7.5 `host_identifiers`
Stores multiple identifiers for a host, with provenance and confidence.

**Fields**
- `host_identifier_id` (uuid, pk)
- `host_id` (uuid, fk -> `hosts`, required)
- `id_type` (text, required) — `machine_id`, `product_uuid`, `serial`, `ssh_hostkey_sha256`, `fqdn`, `hostname`
- `id_value` (text, required)
- `confidence` (int, required) — 0..100
- `first_seen_at` (timestamptz, required)
- `last_seen_at` (timestamptz, required)
- `observation_id` (uuid, fk -> `observations`, required)
- `evidence_id` (uuid, fk -> `evidence_refs`, required)
- `created_at` (timestamptz, required)

**Constraints**
- unique (`id_type`, `id_value`) **globally** unless you explicitly allow duplicates (recommended: keep global-unique for strong IDs like machine-id/ssh hostkey hash; allow duplicates only for weak IDs like hostname via a policy list in ingestion)

---

### 7.6 `interfaces`
Represents interfaces on a host (MAC anchors many mappings).

**Fields**
- `interface_id` (uuid, pk)
- `host_id` (uuid, fk -> `hosts`, required)
- `if_name` (text, optional) — e.g., `eth0`, `ens18`
- `mac_address` (text, required) — normalized (lowercase, `aa:bb:cc:dd:ee:ff`)
- `first_seen_at` (timestamptz, required)
- `last_seen_at` (timestamptz, required)
- `observation_id` (uuid, fk -> `observations`, required)
- `evidence_id` (uuid, fk -> `evidence_refs`, required)
- `created_at` (timestamptz, required)

**Constraints**
- unique (`mac_address`) unless you decide to support MAC reuse (if supported, then uniqueness becomes (`mac_address`, `first_seen_at`) and you must add conflict handling)

---

### 7.7 `ip_addresses`
Canonical IP objects.

**Fields**
- `ip_id` (uuid, pk)
- `ip_version` (int, required) — 4 or 6
- `ip_text` (text, required) — normalized canonical string
- `created_at` (timestamptz, required)

**Constraints**
- unique (`ip_version`, `ip_text`)

---

### 7.8 `networks`
Optional table for CIDR networks.

**Fields**
- `network_id` (uuid, pk)
- `cidr` (text, required) — e.g., `192.168.0.0/24`
- `name` (text, optional) — e.g., `LAN`
- `created_at` (timestamptz, required)

**Constraints**
- unique (`cidr`)

---

### 7.9 `claims_host_ip`
Time-windowed claims that a host had an IP (optionally via interface/network).

**Fields**
- `claim_id` (uuid, pk)
- `host_id` (uuid, fk -> `hosts`, required)
- `ip_id` (uuid, fk -> `ip_addresses`, required)
- `interface_id` (uuid, fk -> `interfaces`, optional)
- `network_id` (uuid, fk -> `networks`, optional)
- `valid_from` (timestamptz, required)
- `valid_to` (timestamptz, optional)
- `confidence` (int, required) — 0..100
- `claim_state` (text, required) — `active`, `superseded`, `conflicted`, `retracted`
- `observation_id` (uuid, fk -> `observations`, required)
- `evidence_id` (uuid, fk -> `evidence_refs`, required)
- `created_at` (timestamptz, required)

**Constraints**
- `valid_to` must be null or >= `valid_from`
- Index required: (`ip_id`, `valid_to nulls first`, `valid_from desc`)
- Index required: (`host_id`, `valid_to nulls first`, `valid_from desc`)

---

### 7.10 `conflicts`
Explicit record of a conflict between two claims.

**Fields**
- `conflict_id` (uuid, pk)
- `left_claim_id` (uuid, fk -> `claims_host_ip`, required)
- `right_claim_id` (uuid, fk -> `claims_host_ip`, required)
- `conflict_kind` (text, required) — e.g., `simultaneous_ip`, `mac_move`, `hostname_reuse`
- `detected_at` (timestamptz, required)
- `severity` (text, required) — `info`, `warn`, `high`
- `notes` (text, optional)
- `created_at` (timestamptz, required)

**Constraints**
- unique (`left_claim_id`, `right_claim_id`, `conflict_kind`)

---

## 8. Ingestion Rules (V1)

### 8.1 Canonicalization
- IP: normalize to canonical string (v4 dotted quad; v6 compressed canonical)
- MAC: lowercase `aa:bb:cc:dd:ee:ff`
- Hostnames: store raw + a normalized variant if needed (do not force uniqueness)

### 8.2 Claim creation and supersession
When a new observation asserts `host_id -> ip_id`:
- If there is an **active** claim for the same `host_id` and `ip_id`, extend `last_seen_at` style fields (or leave as is) and keep it active.
- If there is an **active** claim for `host_id` with a **different** `ip_id`, set its `valid_to = new.valid_from` and mark it `superseded` (unless overlap is explicitly observed).
- If there is an **active** claim for the same `ip_id` but **different** `host_id` that overlaps in time, create a `conflicts` row and set both claims to `conflicted` (policy-driven).

### 8.3 Confidence scoring guidance (recommendation)
- 95–100: verified by stable identifiers (machine-id, ssh host key hash) + direct host evidence
- 80–94: MAC + ARP + consistent hostname
- 60–79: DHCP lease + hostname only
- <60: weak inference (single scan, no corroboration)

Confidence should be computed by ingestion, not edited by Aurora.

---

## 9. Query Contract (Aurora Read-Only)

Aurora (or `aegis-ask`) should be able to answer:

- “What host is most likely associated with IP X right now?”
- “What IPs has host Y had over time?”
- “Show evidence provenance for this relationship.”
- “List conflicts involving IP X.”

### 9.1 Minimum views (recommended)
Create SQL views to simplify read-only access:

- `v_ip_current_owner` — best current host for each IP (highest confidence active claim)
- `v_host_current_ips` — active IPs per host
- `v_host_identity_summary` — host + identifiers summary (top-ranked identifiers)
- `v_claim_provenance` — claim joined to observation + evidence refs + source

Aurora should query views, not raw tables, unless debugging.

---

## 10. Security and Governance Requirements

- DB role separation:
  - `netrel_writer`: insert/update via ingestion pipeline only
  - `netrel_reader`: read-only for Aurora
- No secrets in `artifact_uri` or `notes`
- Evidence artifacts must live in an access-controlled evidence store; DB stores **references + hashes only**
- All writes must be attributable to an `observation_id` + `evidence_id`
- Conflicts must never be auto-deleted

---

## 11. Retention and Maintenance

- Claims: retain indefinitely (preferred) or apply long retention (e.g., 1 year+) depending on storage.
- Evidence refs: retain hashes indefinitely; artifact lifecycle is separate policy.
- Vacuum/analyze and index maintenance as normal Postgres ops.

---

## 12. Minimal Example Flows (Narrative)

### Flow A — SSH evidence from capsuleer
1. Pipeline runs `ip addr`, `hostnamectl`, interface enumeration.
2. Create `observation` with `source_type=ssh`.
3. Store each raw output artifact as an evidence blob; insert `evidence_refs` for each.
4. Resolve or create `host` (via strong identifiers).
5. Upsert interfaces (MAC).
6. Upsert IPs.
7. Create/update `claims_host_ip` with high confidence and supersede old claims.

### Flow B — LAN scan (ARP table)
1. Collector reads ARP cache + optional DHCP lease file.
2. Create `observation` with `source_type=arp_table` / `dhcp_lease`.
3. Create low-to-mid confidence claims unless corroborated later by host evidence.

---

## 13. Open Issues / V2 Candidates

- Port ownership relationships (`ip:port -> process/service domain`) as a linked graph
- NAT/VPN overlays and “seen via” hops
- Multi-tenant host aliasing (containers/VMs)
- Better time-window inference from intermittent observations
- Stronger conflict resolution policy and triage surfacing

---

## 14. Implementation Notes (Non-Normative)

- Prefer `uuid` generation in application (or `gen_random_uuid()` if using `pgcrypto`)
- Use partial indexes for `valid_to IS NULL` queries
- Enforce confidence bounds with a CHECK constraint (0..100)
- Store `collector_run_id` so ingestion is idempotent

---

## 15. Change Log

- **V1 (Draft):** Initial schema and governance rules for Host/IP relationship observability.
