name: AEGIS GitHub -> Discord

on:
  issues:
    types: [opened, edited, closed, reopened]
  issue_comment:
    types: [created]
  pull_request:
    types: [opened, edited, closed, reopened]
  release:
    types: [published]
  workflow_dispatch:

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
      - name: Post GitHub event to Discord
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          set -euo pipefail

          if [ -z "${DISCORD_WEBHOOK:-}" ]; then
            echo "DISCORD_WEBHOOK secret is empty or not set."
            exit 2
          fi

          # Pull key fields from the GitHub event payload
          ACTION="$(jq -r '.action // ""' "$GITHUB_EVENT_PATH")"
          URL="$(jq -r '.issue.html_url // .pull_request.html_url // .release.html_url // .repository.html_url // ""' "$GITHUB_EVENT_PATH")"
          TITLE="$(jq -r '.issue.title // .pull_request.title // .release.name // "(no title)"' "$GITHUB_EVENT_PATH")"

          EVENT_NAME="${GITHUB_EVENT_NAME}"
          ACTOR="${GITHUB_ACTOR}"
          REPO="${GITHUB_REPOSITORY}"

          CONTENT="**${EVENT_NAME} â†’ ${ACTION}**\n**Repo:** ${REPO}\n**Title:** ${TITLE}\n**By:** ${ACTOR}\n${URL}"

          PAYLOAD="$(jq -n --arg content "$CONTENT" '{content: $content}')"

          echo "Webhook set: True"
          echo "Event: ${EVENT_NAME} Action: ${ACTION}"
          echo "Repo: ${REPO}"
          echo "Payload bytes: $(printf '%s' "$PAYLOAD" | wc -c | tr -d ' ')"
          echo "Target URL present: $( [ -n "$URL" ] && echo True || echo False )"

          # Post to Discord (User-Agent is important to avoid Cloudflare 1010 blocks)
          curl -sS --fail-with-body \
            -H "Content-Type: application/json" \
            -H "User-Agent: GitHubActions-AEGIS/1.0 (+https://github.com/${REPO})" \
            -X POST \
            -d "$PAYLOAD" \
            "$DISCORD_WEBHOOK"

          echo "Discord post: OK"
