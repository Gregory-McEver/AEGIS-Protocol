name: AEGIS GitHub ‚Üí Discord

on:
  issues:
    types: [opened, edited, closed, reopened]
  issue_comment:
    types: [created, edited]
  pull_request:
    types: [opened, edited, closed, reopened, ready_for_review, converted_to_draft, synchronize]
  release:
    types: [published, edited]
  workflow_dispatch:

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Post GitHub event to Discord
        env:
          DISCORD_WEBHOOK_RAW: ${{ secrets.DISCORD_WEBHOOK }}
        shell: bash
        run: |
          set -euo pipefail

          WEBHOOK="$(printf '%s' "${DISCORD_WEBHOOK_RAW:-}" | tr -d '\r\n')"
          if [ -z "$WEBHOOK" ]; then
            echo "Missing DISCORD_WEBHOOK secret"
            exit 1
          fi

          EVENT="${GITHUB_EVENT_NAME}"
          ACTION="$(jq -r '.action // ""' "$GITHUB_EVENT_PATH")"

          # ---- helpers ----
          # escape triple backticks so Discord code blocks don't break
          # trim to 900 chars to stay safely under Discord embed field limits
          clean_text() {
            jq -r --arg path "$1" '
              (getpath($path | split(".")) // "") 
              | tostring
              | gsub("\r"; "")
              | gsub("```"; "``\u200b`")
              | if length > 900 then .[0:900] + "‚Ä¶" else . end
            ' "$GITHUB_EVENT_PATH"
          }

          post_embed() {
            local title="$1"
            local url="$2"
            local description="$3"
            local field_name="$4"
            local field_value="$5"

            if [ -z "$field_value" ]; then
              field_value="(no text found)"
            fi

            payload="$(
              jq -n \
                --arg title "$title" \
                --arg url "$url" \
                --arg description "$description" \
                --arg field_name "$field_name" \
                --arg field_value "```$field_value```" \
                '{
                  embeds: [
                    {
                      title: $title,
                      url: $url,
                      description: $description,
                      fields: [
                        { name: $field_name, value: $field_value, inline: false }
                      ]
                    }
                  ]
                }'
            )"

            curl -sS -H "Content-Type: application/json" -X POST -d "$payload" "$WEBHOOK" >/dev/null
          }

          # ---- event routing ----
          case "$EVENT" in
            issue_comment)
              NUM="$(jq -r '.issue.number' "$GITHUB_EVENT_PATH")"
              ITITLE="$(jq -r '.issue.title' "$GITHUB_EVENT_PATH")"
              AUTHOR="$(jq -r '.comment.user.login' "$GITHUB_EVENT_PATH")"
              URL="$(jq -r '.comment.html_url' "$GITHUB_EVENT_PATH")"
              BODY="$(clean_text 'comment.body')"

              DESC="[#${NUM}] ${ITITLE}\nby **${AUTHOR}**"
              post_embed "üõ°Ô∏è AEGIS ‚Äî Issue Comment ${ACTION}" "$URL" "$DESC" "Comment" "$BODY"
              ;;

            issues)
              NUM="$(jq -r '.issue.number' "$GITHUB_EVENT_PATH")"
              ITITLE="$(jq -r '.issue.title' "$GITHUB_EVENT_PATH")"
              AUTHOR="$(jq -r '.sender.login' "$GITHUB_EVENT_PATH")"
              URL="$(jq -r '.issue.html_url' "$GITHUB_EVENT_PATH")"
              STATE="$(jq -r '.issue.state' "$GITHUB_EVENT_PATH")"
              BODY="$(clean_text 'issue.body')"

              DESC="[#${NUM}] ${ITITLE}\nby **${AUTHOR}** ‚Ä¢ state: **${STATE}**"
              post_embed "üõ°Ô∏è AEGIS ‚Äî Issue ${ACTION}" "$URL" "$DESC" "Body" "$BODY"
              ;;

            pull_request)
              NUM="$(jq -r '.pull_request.number' "$GITHUB_EVENT_PATH")"
              PTITLE="$(jq -r '.pull_request.title' "$GITHUB_EVENT_PATH")"
              AUTHOR="$(jq -r '.pull_request.user.login' "$GITHUB_EVENT_PATH")"
              URL="$(jq -r '.pull_request.html_url' "$GITHUB_EVENT_PATH")"
              HEAD="$(jq -r '.pull_request.head.ref' "$GITHUB_EVENT_PATH")"
              BASE="$(jq -r '.pull_request.base.ref' "$GITHUB_EVENT_PATH")"
              BODY="$(clean_text 'pull_request.body')"

              DESC="[#${NUM}] ${PTITLE}\nby **${AUTHOR}**\n‚Üí **${HEAD}** into **${BASE}**"
              post_embed "üõ°Ô∏è AEGIS ‚Äî Pull Request ${ACTION}" "$URL" "$DESC" "Body" "$BODY"
              ;;

            release)
              NAME="$(jq -r '.release.name // .release.tag_name // "Release"' "$GITHUB_EVENT_PATH")"
              TAG="$(jq -r '.release.tag_name // ""' "$GITHUB_EVENT_PATH")"
              AUTHOR="$(jq -r '.release.author.login // .sender.login // "unknown"' "$GITHUB_EVENT_PATH")"
              URL="$(jq -r '.release.html_url' "$GITHUB_EVENT_PATH")"
              NOTES="$(clean_text 'release.body')"

              if [ -n "$TAG" ]; then
                DESC="**${NAME}** (`${TAG}`)\nby **${AUTHOR}**"
              else
                DESC="**${NAME}**\nby **${AUTHOR}**"
              fi

              post_embed "üöÄ AEGIS ‚Äî Release ${ACTION}" "$URL" "$DESC" "Notes" "$NOTES"
              ;;

            workflow_dispatch)
              URL="https://github.com/${GITHUB_REPOSITORY}/actions"
              DESC="Manual test fired successfully.\nWebhook + secret are working."
              post_embed "üß™ AEGIS ‚Äî Manual Test" "$URL" "$DESC" "Status" "OK"
              ;;

            *)
              URL="https://github.com/${GITHUB_REPOSITORY}"
              DESC="Event: **${EVENT}** ${ACTION}"
              post_embed "AEGIS GitHub Update" "$URL" "$DESC" "Info" "See repo for details."
              ;;
          esac
